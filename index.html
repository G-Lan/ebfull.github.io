<!-- javascript bitcoin simulator -->
<!-- sean bowe -->
<!doctype html>
<html>
<head>
<title>selfish mining attack simulator</title>
<style>
.network {
  border: 1px solid #DEDEDE;
  display:block;
  margin:auto;
}

svg {
  margin: auto;
  display:block;
}

rect {
  fill: none;
  pointer-events: all;
}

.node {
  fill: #000;
}

.link {
  stroke: #999;
}
</style>
<script src="d3.v3.min.js"></script>
<script src="jquery.min.js"></script>
<script src="goog/base.js"></script>
<script>
goog.require("goog.structs.PriorityQueue")
</script>
<script src="network.js"></script> <!-- core of simulator -->
<script src="peermgr.js"></script> <!-- PeerMgr for network formation -->
<script src="inventory.js"></script> <!-- Inventory for shared object collection -->
<script src="transactions.js"></script> <!-- Shared UTXO state transitions, mempool, mapOrphans -->
<script src="blockchain.js"></script>
<script src="miner.js"></script>
</head>
<body>
<div class="network"></div>
<a href="#" id="stopvis">disable visualizer (faster but less cool)</a>
<hr>
<b><a id="pause" href="#">(pause)</a></b> <b><a id="default" href="#">(default)</a></b> <b><a id="faster" href="#">+</a></b>/<b><a id="slower" href="#">-</a></b> <span id="timenow"></span><br /><br />
<!--<a id="restart" href="#">Restart</a><br />-->
<div id="statchart"></div>
<script>
var net;
var btc;
var interval = 10;
var visualize = true;

var targetHeight = 5000;
var numNodes = 200;

var trials = []

for (var i=0.4;i<0.5;i+=0.01) {
	trials.push({percent:i, sybil: true, attack: true})
	trials.push({percent:i, sybil: false, attack: false})
}

function start(percent, sybil, attack) {
	$("#statchart").append('<br />(' + (attack ? "selfish," : "") + (sybil ? "sybil" : "") + ') <b>' + (percent*100) + '%</b>: <span class="stat"><span>')
	var allpercent = 1;
	btc = new Node();

	btc.use(PeerMgr);
	btc.use(Inventory);
	btc.use(Transactions);
	btc.use(Blockchain);
	btc.use(Miner);

	btc.init(function() {
		if(this.id == 0) {
			this.mine(percent)
			allpercent-=percent;
			if (attack)
				this.attack()
			if (sybil)
				this.peers.maxpeers = numNodes - 1;
		}
		else {
			var thispercent = Math.random() * (allpercent * 0.3)
			allpercent -= thispercent;
			this.mine(thispercent)
		}
	})
	
/*
	btc.prob("txnoise", 0.000001, function() {
		this.mempool.createTransaction();
	})
*/
	net = new Network(visualize ? ".network" : undefined)
	net.add(numNodes, btc)
}

var curtrial = trials.shift()
start(curtrial.percent, curtrial.sybil, curtrial.attack);

setInterval(function() {
	if (typeof net != "undefined") {
		net.run(interval);
		$("#timenow").html((net.now/1000) + " seconds elapsed");
		var total = 0;
		var my = 0;
		var cur = net.nodes[99].blockchain.chainstate.head;
		while (cur) {
			if (cur.credit === 0)
				my++;
			total++;
			cur = cur._prev();
		}
		var pub = net.nodes[0].blockchain.chainstate.head.h;
		var lol = 0;
		if (typeof net.nodes[0].private_blockchain != "undefined")
			lol = net.nodes[0].private_blockchain.chainstate.head.h;

		var revPerHour = ((my / (net.now/(1000*60*60)))).toFixed(2)

		if (total > 0)
			$(".stat:last").html("height=" + pub + "/" + targetHeight + "; revenue= " + ((my/total)*100).toFixed(2) + "%; revenue per hour: " + revPerHour)

		if (pub >= targetHeight) {
			// we're done with this trial
			curtrial = trials.shift()
			if (curtrial)
				start(curtrial.percent, curtrial.sybil, curtrial.attack)
			else
				net = undefined;
		}
	}
}, 10)

$("#restart").click(function() {
	start();
	return false;
})

$("#faster").click(function() {
	interval *= 2;
	interval = Math.floor(interval);
	return false;
})

$("#default").click(function() {
	interval = 10;
	return false;
})

$("#pause").click(function() {
	interval = 0;
	return false;
})

$("#slower").click(function() {
	interval /= 2;
	interval = Math.floor(interval);
	return false;
})

$("#stopvis").click(function() {
	visualize = false;
	net.visualizer = false;
	$(".network").html("")
	$(".network").css("display", "none")
	$(this).remove();
	return false;
})
</script>
</body>
</html>