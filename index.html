<!-- javascript bitcoin simulator -->
<!doctype html>
<html>
<head>
<title>javascript bitcoin simulation</title>
<style>
.network {
  border: 1px solid #DEDEDE;
  display:block;
  margin:auto;
}

svg {
  margin: auto;
  display:block;
}

rect {
  fill: none;
  pointer-events: all;
}

.node {
  fill: #000;
}

.link {
  stroke: #999;
}
</style>
<script src="d3.v3.min.js"></script>
<script src="jquery.min.js"></script>
<script src="goog/base.js"></script>
<script>
goog.require("goog.structs.PriorityQueue")
</script>
<script src="network.js"></script> <!-- core of simulator -->
<script src="peermgr.js"></script> <!-- PeerMgr for network formation -->
<script src="inventory.js"></script> <!-- Inventory for shared object collection -->
<!--<script src="transactions.js"></script>--> <!-- Shared UTXO state transitions, mempool, mapOrphans -->
<!--
<script src="blockchain.js"></script>
-->
</head>
<body>
<div class="network"></div>
<hr>
<b><a id="pause" href="#">(pause)</a></b> <b><a id="default" href="#">(default)</a></b> <b><a id="faster" href="#">+</a></b>/<b><a id="slower" href="#">-</a></b> <span id="timenow"></span><br /><br />
<a id="restart" href="#">Restart</a><br />
<span id="stat"></span>
<script>
var net;
var btc;
var interval = 10;
var findtx = true;

var l = 0;

function start() {
	btc = new Node();

	btc.use(PeerMgr);
	btc.prob("lol", (0.000003), function() {
		if (findtx && this.peers.numpeers > 4) {
			var tx = {name:""+Math.random(),test:Math.random()};
			console.log(this.id + ": creating tx " + tx.name)

			this.inventory.createObj("tx", tx)
		}
	})
	btc.on("inv:tx", function(from, obj) {
		//console.log(this.id + ": received tx from " + from + ": " + obj.id)
	})
	btc.use(Inventory);
	/*

	btc.prob("transaction", 1000, 0.001, function() {
		if (this.peers.numpeers > 3) {
			var newobj = new InventoryTransition("" + Math.random(), "TEST " + Math.random())
			var val = this.inventory.validate(newobj)

			this.inventory = this.inventory.shift(newobj, val)
			this.peers.broadcast("newtx", newobj)
		}
	})

	btc.on("newtx", function(from, obj) {
		var val = this.inventory.validate(obj)
		if (val.state == val.VALID) {
			this.inventory = this.inventory.shift(obj, val)

			this.peers.broadcast("newtx", obj)
		}
	})
*/
	//btc.use(Transactions);

	net = new Network(/*".network"*/)
	net.add(200, btc)
}

start();

setInterval(function() {
	if (typeof net != "undefined") {
		net.run(interval);
		$("#timenow").html((net.now/1000) + " seconds elapsed");
		/*
		// for fun
		var invchain = "";
		var at = net.nodes[0].inventory;
		while (at) {
			invchain += "(" + at.transitions.length + ") -> ";
			at = at.parent;
		}
		$("#stat").html(invchain);
		*/
		$("#stat").html(Object.keys(net.nodes[0].inventory.inv.root.shifts).length)
		//$("#stat").html(net.nodes[0].inventory.inv._retain)
	}
}, 10)

$("#restart").click(function() {
	start();
	return false;
})

$("#faster").click(function() {
	interval *= 2;
	interval = Math.floor(interval);
	return false;
})

$("#default").click(function() {
	interval = 10;
	return false;
})

$("#pause").click(function() {
	interval = 0;
	return false;
})

$("#slower").click(function() {
	interval /= 2;
	interval = Math.floor(interval);
	return false;
})
</script>
</body>
</html>