<!-- javascript NTP simulator -->
<!-- sean bowe -->
<!doctype html>
<html>
<head>
<title>javascript NTP simulation</title>
<style>
.network {
  border: 1px solid #DEDEDE;
  display:block;
  margin:auto;
}

svg {
  margin: auto;
  display:block;
}

rect {
  fill: none;
  pointer-events: all;
}

.node {
  fill: #000;
}

.link {
  stroke: #999;
}
</style>
<script src="d3.v3.min.js"></script>
<script src="jquery.min.js"></script>
<script src="goog/base.js"></script>
<script>
goog.require("goog.structs.PriorityQueue")
</script>
<script src="network.js"></script> <!-- core of simulator -->
<script src="peermgr.js"></script> <!-- PeerMgr for network formation -->
</head>
<body>
<div class="network"></div>
<hr>
<b><a id="pause" href="#">(pause)</a></b> <b><a id="default" href="#">(default)</a></b> <b><a id="faster" href="#">+</a></b>/<b><a id="slower" href="#">-</a></b> <span id="timenow"></span><br /><br />
<a id="restart" href="#">Restart</a><br />
<div id="statchart"></div>
<script>
var ntp = new Node();
ntp.use(PeerMgr)

ntp.init(function() {
	this.results = []
	this.period = 0

	this.delta = Math.floor(Math.random() * 10000)
	if (Math.random() < 0.5)
		this.delta *= -1;

	this.getTime = function() {
		return this.now() + this.delta;
	}

	this.setTime = function(delta) {
		this.delta += delta;
	}
})

// trials (every second)
ntp.tick(1000, function() {
	for (var p in this.peers.peers) {
		var peer = this.peers.peers[p]
		if (peer.active) {
			this.peers.send(peer.id, "ping", {start:this.getTime(),period:this.period})
		}
	}
})

// update our time (every ten seconds)
ntp.tick(10000, function() {
	if (this.results.length > 0) {
		var avg = 0;
		this.results.forEach(function(delta) {
			avg += delta;
		})

		avg /= this.results.length;
		avg = Math.floor(avg)

		this.setTime(avg)
	}

	this.results = []
	this.period++
})

ntp.on("ping", function(from, o) {
	this.peers.send(from, "pong", {period:o.period,start:o.start,end:this.getTime()})
})

ntp.on("pong", function(from, roundtrip) {
	if (roundtrip.period != this.period)
		return // ignore this pong

	var delay = (this.getTime() - roundtrip.start) / 2
	var newTime = roundtrip.end + delay;
	var newDelta = newTime - this.getTime()

	this.results.push(newDelta)
})

var net;
var interval = 10;
var numNodes = 100;

function start() {
	net = new Network(".network")
	net.add(numNodes, ntp)
}

start()

average = function(a) {
  var r = {mean: 0, variance: 0, deviation: 0}, t = a.length;
  for(var m, s = 0, l = t; l--; s += a[l]);
  for(m = r.mean = s / t, l = t, s = 0; l--; s += Math.pow(a[l] - m, 2));
  return r.deviation = Math.sqrt(r.variance = s / t), r;
}

setInterval(function() {
	if (typeof net != "undefined") {
		net.run(interval);
		$("#timenow").html((net.now/1000) + " seconds elapsed");

		// collect each node's time
		var times = []

		net.nodes.forEach(function(node) {
			times.push(node.getTime())
		})

		var x = average(times)

		$("#statchart").html("standard deviation: " + x.deviation)
	}
}, 10)

$("#restart").click(function() {
	start();
	return false;
})

$("#faster").click(function() {
	interval *= 2;
	interval = Math.floor(interval);
	return false;
})

$("#default").click(function() {
	interval = 10;
	return false;
})

$("#pause").click(function() {
	interval = 0;
	return false;
})

$("#slower").click(function() {
	interval /= 2;
	interval = Math.floor(interval);
	return false;
})
</script>
</body>
</html>